<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionAssist Kiosk</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/kspatel45/VisionAssist/main/Vision%20Assist%20logo.png">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --signifi-navy: #0D202D; --accent-cyan: #72E0FB; --danger: #ff4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { height: 100%; width: 100%; overflow: hidden; background: var(--signifi-navy); font-family: 'Segoe UI', sans-serif; }

        #kiosk-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://raw.githubusercontent.com/kspatel45/VisionAssist/main/TED%20background.jpg');
            background-size: cover; background-position: center; z-index: 1;
        }

        #video-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(13, 32, 45, 0.98); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(20px);
        }
        
        #remote-video { width: 100%; height: 100%; background: #000; object-fit: cover; }
        #local-preview { position: absolute; top: 30px; right: 30px; width: 220px; height: 140px; border-radius: 15px; border: 2px solid var(--accent-cyan); object-fit: cover; z-index: 110; transform: scaleX(-1); }

        .controls { position: absolute; bottom: 40px; display: flex; gap: 20px; z-index: 120; }
        .btn-end { background: var(--danger); width: 180px; height: 70px; border-radius: 40px; color: white; border: none; font-weight: bold; cursor: pointer; font-size: 1.1rem; }

        #call-trigger { position: absolute; z-index: 10; bottom: 0; left: 0; width: 100%; height: 50%; cursor: pointer; border: none; background: transparent; }
        #admin-lock { position: fixed; top: 0; right: 0; width: 80px; height: 80px; z-index: 999; cursor: pointer; }

        /* Admin Modal */
        .admin-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .admin-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; color: #333; }
        select { width: 100%; padding: 10px; margin: 10px 0 20px; border-radius: 5px; border: 1px solid #ccc; }
        .admin-btn { background: var(--signifi-navy); color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div id="kiosk-bg"></div>
    <div id="admin-lock" onclick="openAdmin()"></div>
    <button id="call-trigger" onclick="startCall()"></button>

    <div id="video-overlay">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-preview" autoplay muted playsinline></video>
        <div class="controls"><button class="btn-end" onclick="hangUp()">END CALL</button></div>
    </div>

    <div id="admin-panel" class="admin-modal">
        <div class="admin-content">
            <h3>Kiosk Hardware Settings</h3>
            <label>Camera:</label> <select id="cam-select"></select>
            <label>Microphone:</label> <select id="mic-select"></select>
            <label>Speaker (Chrome/Edge):</label> <select id="spk-select"></select>
            <button class="admin-btn" onclick="loadDevices()">REFRESH DEVICES</button>
            <button class="admin-btn" style="background:#28a745;" onclick="saveSettings()">SAVE & REFRESH</button>
            <button class="admin-btn" style="background:#888;" onclick="closeAdmin()">CANCEL</button>
        </div>
    </div>

    <script>
        const peer = new Peer('Signifi-Kiosk-Unit-01'); 
        let localStream, currentCall;

        async function startCall() {
            try {
                // Flexible HD constraints
                const constraints = {
                    video: { 
                        deviceId: localStorage.getItem('kiosk-cam') ? { exact: localStorage.getItem('kiosk-cam') } : undefined,
                        width: { ideal: 1280 }, height: { ideal: 720 } 
                    },
                    audio: { 
                        deviceId: localStorage.getItem('kiosk-mic') ? { exact: localStorage.getItem('kiosk-mic') } : undefined,
                        echoCancellation: true 
                    }
                };

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const remoteVideo = document.getElementById('remote-video');
                if (localStorage.getItem('kiosk-spk') && remoteVideo.setSinkId) {
                    await remoteVideo.setSinkId(localStorage.getItem('kiosk-spk'));
                }

                document.getElementById('local-preview').srcObject = localStream;
                document.getElementById('video-overlay').style.display = 'flex';
                
                currentCall = peer.call('Expert-Laptop-Station', localStream);
                currentCall.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
                currentCall.on('close', () => location.reload());
            } catch (err) {
                console.error(err);
                alert("Could not start camera. Check Admin settings.");
            }
        }

        function hangUp() { if(currentCall) currentCall.close(); location.reload(); }
        function openAdmin() { if(prompt("Password:") === "123") { document.getElementById('admin-panel').style.display = 'flex'; loadDevices(); } }
        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }

        async function loadDevices() {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cam = document.getElementById('cam-select'), mic = document.getElementById('mic-select'), spk = document.getElementById('spk-select');
                cam.innerHTML = mic.innerHTML = spk.innerHTML = "";
                devices.forEach(d => {
                    const opt = new Option(d.label || `Device ${d.deviceId.slice(0,5)}`, d.deviceId);
                    if(d.kind === 'videoinput') cam.add(opt);
                    if(d.kind === 'audioinput') mic.add(opt);
                    if(d.kind === 'audiooutput') spk.add(opt);
                });
                cam.value = localStorage.getItem('kiosk-cam');
                mic.value = localStorage.getItem('kiosk-mic');
                spk.value = localStorage.getItem('kiosk-spk');
            } catch (err) { alert("Permission denied."); }
        }

        function saveSettings() {
            localStorage.setItem('kiosk-cam', document.getElementById('cam-select').value);
            localStorage.setItem('kiosk-mic', document.getElementById('mic-select').value);
            localStorage.setItem('kiosk-spk', document.getElementById('spk-select').value);
            location.reload();
        }
    </script>
</body>
</html>
